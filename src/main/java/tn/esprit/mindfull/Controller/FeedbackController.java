package tn.esprit.mindfull.Controller;

import lombok.AllArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.bind.annotation.*;
import tn.esprit.mindfull.Respository.FeedbackRepository;
import tn.esprit.mindfull.Service.AIService;
import tn.esprit.mindfull.entity.Feedback;
import tn.esprit.mindfull.Service.FeedbackService;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/feedback")
@AllArgsConstructor
@CrossOrigin(origins = "http://localhost:4200") // üî• Pour autoriser Angular localhost:4200
public class FeedbackController {

    @Autowired
    private FeedbackService feedbackService;
    private final List<String> notifications = new ArrayList<>(); // üõéÔ∏è Liste de notifications

    @Autowired
    private AIService aiService;
    private FeedbackRepository feedbackRepository;

  /*  @PostMapping
    public ResponseEntity<String> receiveFeedback(@RequestBody Map<String, Object> feedback) {
        try {
            // üîµ Lire rating et comment envoy√©s depuis Angular
            String ratingStr = feedback.get("rating").toString(); // ‚úîÔ∏è pas de cast direct
            Integer rating = Integer.parseInt(ratingStr); // ‚úîÔ∏è convertir
            String comment = (String) feedback.get("comment");

            // üîµ Juste afficher en console pour v√©rifier
            System.out.println("Rating re√ßu: " + rating);
            System.out.println("Commentaire re√ßu: " + comment);
            // üõéÔ∏è Ajouter une notification pour le coach
            notifications.add("Nouveau feedback re√ßu: " + comment);

            // üîµ Envoyer une r√©ponse au frontend
            return ResponseEntity.ok("Feedback re√ßu avec succ√®s !");
        } catch (Exception e) {
            e.printStackTrace();
            return ResponseEntity.status(500).body("Erreur lors de la r√©ception du feedback");

        }
    }*/
    // Endpoint pour r√©cup√©rer les notifications
    @GetMapping("/notifications")
    public ResponseEntity<List<String>> getNotifications() {
        List<String> notifications = new ArrayList<>();
        notifications.add("Un nouveau feedback a √©t√© re√ßu !");
        notifications.add("Un autre feedback a √©t√© ajout√© !");
        return ResponseEntity.ok(notifications);
    }

    @PostMapping("/{patientId}/{contentId}")
    public ResponseEntity<Feedback> addFeedback(
            @RequestBody Feedback feedback,
            @PathVariable Long patientId,
            @PathVariable Long contentId
    ) {
        Feedback savedFeedback = feedbackService.addFeedback(feedback, patientId, contentId);
        // üõéÔ∏è Ajouter une notification pour ce feedback aussi
        notifications.add("Nouveau feedback re√ßu pour le contenu ID " + contentId);
        return ResponseEntity.ok(savedFeedback);
    }

    @GetMapping("/average/{programId}")
    public ResponseEntity<Double> getAverageRating(@PathVariable Long programId) {
        double average = feedbackService.getAverageRatingForProgram(programId);
        return ResponseEntity.ok(average);
    }
    // M√©thode pour analyser un feedback
    @PutMapping("/diagnose/{feedbackId}")
    public Feedback diagnoseFeedback(@PathVariable Long feedbackId) {
        // R√©cup√©rer le feedback depuis la base de donn√©es
        Feedback feedback = feedbackRepository.findById(feedbackId).orElseThrow(() -> new RuntimeException("Feedback introuvable"));

        // Obtenir le diagnostic de l'API AI
        String diagnostic = aiService.getDiagnosis(feedback.getComment());

        // D√©finir le diagnostic dans l'objet feedback et le sauvegarder
        feedback.setDiagnostic(diagnostic);
        return feedbackRepository.save(feedback);
    }
    // Endpoint pour r√©cup√©rer tous les feedbacks
    @GetMapping("/all")
    public ResponseEntity<List<Feedback>> getAllFeedbacks() {
        List<Feedback> feedbacks = feedbackService.getAllFeedbacks();  // Assurez-vous que la m√©thode existe dans le service
        return ResponseEntity.ok(feedbacks);
    }

}